---
title: "Examining the MTA ridership between 2019 and 2020"
output: github_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(patchwork)
library(readr)
library(broom)
library(dbplyr)
library(viridis)
library(reshape2)
library(plotly)
library(lubridate)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

theme_set(theme_minimal() + theme(legend.position = "bottom"))
```
link to project rubric: https://p8105.com/final_project.html
### Project Title

### Members:
Aishwarya Anuraj aa4517,
Michelle Lee mjl2241,
JuliÃ¡n Ponce jp3999, 
Adarsh Ramakrishnan ar4040, 
Allison Stewart als2377

### About the Data: 
mta: https://new.mta.info/coronavirus/ridership

``` {r importing data}
mta_data = read_csv (file = "./data/MTA_recent_ridership_data_20201123_0.csv",
                     col_types = cols(
                       date = col_date(format = "%mm/%dd/%yy"),
                       `Subways: % Change From 2019 Equivalent Day` = col_number(),
                       `Buses: % Change From 2019 Equivalent Day` = col_number(),
                       `Bridges and Tunnels: % Change From 2019 Equivalent Day` = col_number()
                       ) #only changed the formats of important variables 
) %>%
  janitor::clean_names()
skimr::skim(mta_data)
mta_data =
  mta_data %>%
  subset(select = -c(lirr_total_estimated_ridership, lirr_percent_change_from_2019_monthly_weekday_saturday_sunday_average, metro_north_total_estimated_ridership, metro_north_percent_change_from_2019_monthly_weekday_saturday_sunday_average, access_a_ride_total_scheduled_trips, access_a_ride_percent_change_from_2019_monthly_weekday_saturday_sunday_average, bridges_and_tunnels_total_traffic, bridges_and_tunnels_percent_change_from_2019_equivalent_day))
#exclude data for lirr, metronorth, access-a-ride, bridges & tunnel
```
Now we will calculate the actual 2019 ridership based on the percent change data

``` {r calculate 2019 ridership bus subway}
mta_data = mta_data %>%
  mutate( 
    'subway_2019' = subways_total_estimated_ridership/(1+(subways_percent_change_from_2019_equivalent_day/100)),
    'bus_2019'=
      buses_total_estimated_ridership/(1+(buses_percent_change_from_2019_equivalent_day/100))
    ) %>%
  rename(
    "subway_2020" = subways_total_estimated_ridership,
    "subway_pct_change" = subways_percent_change_from_2019_equivalent_day,
    "bus_2020" = buses_total_estimated_ridership,
    "bus_pct_change" = buses_percent_change_from_2019_equivalent_day
    )
```


```{r plotting general trends of MTA ridership 2019 & 2020}
#change date to date format and order by date
mta_data =
  mta_data %>%
  mutate(
    date= as.Date(date,format = "%m/%d")) %>%
  arrange(date)
#graph for subway 
#pivoting
plot_subway = 
  mta_data %>%
  select(subway_2019, subway_2020, date) %>%
  melt(., id.vars = "date") %>%
#plotting
  plot_ly(
    x = ~date, y = ~value, type = "scatter", mode = "markers",
    color = ~variable, text_label=~value) %>%
  layout (
    title = "Subway Ridership Trends 2019 - 2020",
    xaxis = list(title ="Month/Day", tickformat = "%m/%d"), #drop year
    yaxis = list(title="Ridership"))
#graph for bus
#pivoting
plot_bus = 
  mta_data %>%
  select(bus_2020, bus_2019,date) %>%
  melt(., id.vars = "date") %>% 
#plotting
  plot_ly(
    x = ~date, y = ~value, type = "scatter", mode = "markers",
    color = ~variable) %>%
  layout (
    title = "MTA Ridership Trends 2019 - 2020",
    xaxis = list(title ="Month/Day", tickformat = "%m/%d"),
    yaxis = list(title="Ridership"))

#ggplot for subway
plot_subway_2 = 
  mta_data %>%
  select(subway_2019, subway_2020, date) %>%
  melt(., id.vars = "date") %>%
  ggplot(aes(x=date, y=value, color=variable)) +
  geom_point(alpha=0.5) +
  geom_smooth(se = FALSE) 
ggplotly(plot_subway_2)

#ggplot for bus
plot_bus_2 = 
  mta_data %>%
  select(bus_2020, bus_2019,date) %>%
  melt(., id.vars = "date") %>% 
  ggplot(aes(x=date, y=value, color=variable)) +
  geom_point(alpha=0.5) +
  geom_smooth(se = FALSE) +  
  scale_x_date(date_labels = "%m/%d")
ggplotly(plot_bus_2)

#see the two graphs together:
plot_bus
plot_subway
(plot_bus_2+plot_subway_2)
```

```{r}
#separate by month and day
mta_data = 
  mta_data %>%
  separate(date, into = c("month", "day", "year"))%>%
  mutate(month = as.numeric(month),
         day = as.numeric(day)) %>%
  select(-c(year)) #drop year column
```
Let us first look at the average ridership of subway during 2019 and 2020 for each month

```{r}
mta_subway_ridership =
  mta_data %>%
  group_by(month)%>%
  summarize(
    avg_subway_2019 = mean(subway_2019),
    avg_subway_2020 = mean(subway_2020)
  )
mta_subway_ridership%>%knitr::kable()
```
Let us now compare 2019 and 2020 ridership by month and check if they are significantly different.

First we need to create our dataframe that nests the observations for 2019 and 2020 subway ridership for each month.
```{r}
mta_2019_sample = 
  mta_data%>%
  select(month, subway_2019) %>%
  nest(subway_2019)%>%
  mutate("subway_2019_sample" = data)%>%
  select(-data)

mta_2020_sample = 
  mta_data%>%
  select(month, subway_2020)%>%
  nest(subway_2020)%>%
  mutate("subway_2020_sample" = data)%>%
  select(-data)

mta_samples = 
  bind_cols(mta_2019_sample, mta_2020_sample)%>%
  select(-month...3)%>%
  rename(month = month...1)
```

Now we need to perform a t-test to check if the subway ridership is signficantly different between 2019 and 2020 data. We map across each month to test if the values of the samples of 2019 and 2020 ridership data differs for each month. We then compare the p-value obtained from the tests to determine whether the differene in ridership numbers is significant or not

```{r}
mta_t_test = mta_samples%>%
  mutate(t_test = map2(.x = subway_2019_sample, .y = subway_2020_sample, ~t.test(.x , .y) ),
         t_test_results = map(t_test, broom::tidy))%>%
  select(month, t_test_results)%>%
  unnest(t_test_results)%>%
  select(month,p.value)%>%
  mutate(difference = case_when(
    p.value >= 0.05 ~ "insignificant",
    p.value < 0.05 ~ "significant"
  ))%>%
  arrange(month)

mta_t_test%>%
  knitr::kable()
```
We can merge the t-test results with the average riderships from before..

```{r}
mta_year_ttest = 
  bind_cols(mta_ridership, mta_t_test)%>%
  select(-month...4)%>%
  rename(month = month...1)
mta_year_ttest%>%knitr::kable()
  
```

Using this final dataframe, we can plot a graph showing the average ridership for each month comparing the 2019 to 2020 ridership and then labelling the signficance or lack of significance in ridership differences..

[Plot needs to be created]
``` {r plotting}
#create a text_label label
text_label =
  mta_year_ttest %>%
    mutate(
    p.value =case_when(
      p.value<0.0001 ~"<0.0001" #changed to p<0.0001 to read easily
    )) %>%
  mutate(text_label = str_c("p-value: ",p.value, "\nDifference: ", difference)) %>%
  select(month, text_label)
#pivoting
plot = 
  mta_ridership %>%
  rename(
    "2019"=avg_subway_2019,
    "2020"=avg_subway_2020
  ) %>%
  melt(., id.vars = "month") %>%
#merge based on month 
  merge(text_label, by = "month")

#plotting
plot %>%
plot_ly(
    x = ~month, y = ~value, type = "scatter", mode = "lines+markers",
    color = ~variable, text = ~text_label) %>%
  layout (
    title = "Monthly Average Ridership of Subway 2019 vs 2020",
    xaxis = list(title ="Months",range=c(3,11)),
    yaxis = list(title="Average Ridership"))
  
```